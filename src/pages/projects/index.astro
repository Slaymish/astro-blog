---
import Layout from "../../components/layout/Layout.astro";
import GridTile from "../../components/ui/GridTile.astro";
import { fetchSanity } from "../../lib/sanity";

export const prerender = false;

type ProjectDoc = {
  title: string;
  description?: string;
  slug: string;
  date: string;
  featured?: boolean;
  technologies?: string[];
};

const projects = await fetchSanity<ProjectDoc[]>(`
  *[_type == "project"] | order(date desc){
    title,
    description,
    "slug": slug.current,
    date,
    featured,
    technologies
  }
`);

const featuredProjects = projects.filter(p => p.featured);
const otherProjects = projects.filter(p => !p.featured);

const allTechnologies = [...new Set(
  projects.flatMap(p => p.technologies || [])
)].sort();

const featuredTiles = featuredProjects.map((project) => ({
  title: project.title,
  description: project.description,
  href: `/projects/${project.slug}`,
  size: 'square' as const,
  tags: project.technologies || [],
  date: new Date(project.date).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short'
  }),
  type: 'project' as const
}));

const otherTiles = otherProjects.map((project) => ({
  title: project.title,
  description: project.description,
  href: `/projects/${project.slug}`,
  size: 'square' as const,
  tags: project.technologies || [],
  date: new Date(project.date).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short'
  }),
  type: 'project' as const
}));
---

<Layout
  title="Projects"
  description="A collection of projects I've worked on, featuring web applications, tools, and experiments."
>
  <div class="projects-page">
    <header class="page-header">
      <h1 class="page-title">projects.</h1>
      <p class="page-subtitle">Things I've built, experiments I've tried, and work in progress.</p>
    </header>

    {allTechnologies.length > 0 && (
      <div class="filter-panel">
        <span class="filter-label">Filter by technology:</span>
        <div class="filter-tags">
          <button class="filter-tag active" data-tech="all">All</button>
          {allTechnologies.map(tech => (
            <button class="filter-tag" data-tech={tech}>{tech}</button>
          ))}
        </div>
      </div>
    )}

    {featuredTiles.length > 0 && (
      <section class="projects-section">
        <h2 class="section-title">Featured</h2>
        <div class="grid grid-cols-1 gap-3 sm:grid-flow-row-dense sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3" id="featured-grid">
          {featuredTiles.map(tile => <GridTile {...tile} />)}
        </div>
      </section>
    )}

    {otherTiles.length > 0 && (
      <section class="projects-section">
        <h2 class="section-title">All Projects</h2>
        <div class="grid grid-cols-1 gap-3 sm:grid-flow-row-dense sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3" id="projects-grid">
          {otherTiles.map(tile => <GridTile {...tile} />)}
        </div>
      </section>
    )}

    {projects.length === 0 && (
      <div class="empty-state">
        <p>No projects yet. Check back soon!</p>
      </div>
    )}
  </div>
</Layout>

<script>
  // Simple filter functionality
  const techButtons = document.querySelectorAll('.filter-tag[data-tech]');
  const allTiles = document.querySelectorAll('.grid-tile');

  techButtons.forEach(button => {
    button.addEventListener('click', () => {
      const tech = button.getAttribute('data-tech');

      if (!tech) return;

      // Update active state
      techButtons.forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');

      // Filter tiles
      allTiles.forEach(tile => {
        const htmlTile = tile as HTMLElement;
        if (tech === 'all') {
          htmlTile.style.display = 'block';
        } else {
          const tags = tile.querySelectorAll('.tile-filter-tag');
          const hasTech = Array.from(tags).some(
            tag => tag.textContent?.toLowerCase() === tech.toLowerCase()
          );
          htmlTile.style.display = hasTech ? 'block' : 'none';
        }
      });
    });
  });
</script>
