---
import Layout from "../../components/layout/Layout.astro";
import { fetchSanity } from "../../lib/sanity";
import { createSlug } from "../../utils/slug";

export const prerender = true;

type TagPath = { tag: string };

type PostDoc = {
  title: string;
  slug: string;
  publishedAt: string;
  excerpt?: string;
  tags?: string[];
};

type ReportDoc = {
  title: string;
  slug: string;
  publishedAt: string;
  description?: string;
  tags?: string[];
};

export async function getStaticPaths() {
  const tags = await fetchSanity<string[]>(`
    array::unique(*[_type in ["post", "report"]].tags[])
  `);

  return tags.map((tag) => ({
    params: { tag: createSlug(tag) },
    props: { tagLabel: tag }
  }));
}

const { tag } = Astro.params as TagPath;
const { tagLabel } = Astro.props as { tagLabel: string };

const posts = await fetchSanity<PostDoc[]>(`
  *[_type == "post" && $tag in tags] | order(publishedAt desc){
    title,
    "slug": slug.current,
    publishedAt,
    excerpt,
    tags
  }
`, { tag: tagLabel });

const reports = await fetchSanity<ReportDoc[]>(`
  *[_type == "report" && $tag in tags] | order(publishedAt desc){
    title,
    "slug": slug.current,
    publishedAt,
    description,
    tags
  }
`, { tag: tagLabel });

const totalItems = posts.length + reports.length;
const displayTag = tagLabel || tag || '';
---

<Layout title={`Content tagged "${displayTag}"`}>
  <div class="max-w-4xl mx-auto">
    <div class="mb-12">
      <h1 class="text-4xl font-bold mb-4" style="color: var(--color-text-primary);">
        Content tagged "{displayTag}"
      </h1>
      <p class="mb-4" style="color: var(--color-text-muted);">
        {totalItems} {totalItems === 1 ? 'item' : 'items'} found
      </p>
      <a href="/" style="color: var(--color-link);" class="hover:underline">
        ‚Üê Back to home
      </a>
    </div>

    {reports.length > 0 && (
      <section class="mb-12">
        <h2 class="text-3xl font-bold mb-6" style="color: var(--color-primary-500);">
          Reports ({reports.length})
        </h2>
        <div class="space-y-8">
          {reports.map((report) => (
            <article 
              class="pb-8 card-hover" 
              style="border-bottom: 1px solid var(--color-border-secondary);"
            >
              <h3 class="text-2xl font-bold mb-2">
                <a 
                  href={`/reports/${report.slug}`}
                  style="color: var(--color-text-primary);" 
                  class="hover:underline transition-colors"
                >
                  {report.title}
                </a>
              </h3>
              <p class="mb-4" style="color: var(--color-text-muted);">
                {new Date(report.publishedAt).toLocaleDateString("en-US", {
                  year: "numeric",
                  month: "long",
                  day: "numeric"
                })}
              </p>
              {report.description && (
                <p class="mb-4" style="color: var(--color-text-secondary);">
                  {report.description}
                </p>
              )}
              {report.tags && report.tags.length > 0 && (
                <div class="flex flex-wrap gap-2">
                  {report.tags.map((t, index) => {
                    const colorVariant = index % 3;
                    let bgColor = 'var(--color-tag-bg)';
                    let textColor = 'var(--color-tag-text)';
                    
                    if (colorVariant === 1) {
                      bgColor = 'var(--color-tag-accent1-bg)';
                      textColor = 'var(--color-tag-accent1-text)';
                    } else if (colorVariant === 2) {
                      bgColor = 'var(--color-tag-accent2-bg)';
                      textColor = 'var(--color-tag-accent2-text)';
                    }
                    
                    return (
                      <a
                        href={`/tags/${createSlug(t)}`}
                        class="text-sm px-3 py-1 rounded-full hover:opacity-80 transition-all"
                        style={`background-color: ${bgColor}; color: ${textColor};`}
                      >
                        {t}
                      </a>
                    );
                  })}
                </div>
              )}
            </article>
          ))}
        </div>
      </section>
    )}

    {posts.length > 0 && (
      <section>
        <h2 class="text-3xl font-bold mb-6" style="color: var(--color-primary-500);">
          Posts ({posts.length})
        </h2>
        <div class="space-y-8">
          {posts.map((post) => (
            <article 
              class="pb-8 card-hover" 
              style="border-bottom: 1px solid var(--color-border-secondary);"
            >
              <h3 class="text-2xl font-bold mb-2">
                <a 
                  href={`/posts/${post.slug}`}
                  style="color: var(--color-text-primary);" 
                  class="hover:underline transition-colors"
                >
                  {post.title}
                </a>
              </h3>
              <p class="mb-4" style="color: var(--color-text-muted);">
                {new Date(post.publishedAt).toLocaleDateString("en-US", {
                  year: "numeric",
                  month: "long",
                  day: "numeric"
                })}
              </p>
              {post.excerpt && (
                <p class="mb-4" style="color: var(--color-text-secondary);">
                  {post.excerpt}
                </p>
              )}
              {post.tags && post.tags.length > 0 && (
                <div class="flex flex-wrap gap-2">
                  {post.tags.map((t, index) => {
                    const colorVariant = index % 3;
                    let bgColor = 'var(--color-tag-bg)';
                    let textColor = 'var(--color-tag-text)';
                    
                    if (colorVariant === 1) {
                      bgColor = 'var(--color-tag-accent1-bg)';
                      textColor = 'var(--color-tag-accent1-text)';
                    } else if (colorVariant === 2) {
                      bgColor = 'var(--color-tag-accent2-bg)';
                      textColor = 'var(--color-tag-accent2-text)';
                    }
                    
                    return (
                      <a
                        href={`/tags/${createSlug(t)}`}
                        class="text-sm px-3 py-1 rounded-full hover:opacity-80 transition-all"
                        style={`background-color: ${bgColor}; color: ${textColor};`}
                      >
                        {t}
                      </a>
                    );
                  })}
                </div>
              )}
            </article>
          ))}
        </div>
      </section>
    )}

    {totalItems === 0 && (
      <div class="text-center py-12">
        <h2 class="text-2xl font-bold mb-4" style="color: var(--color-text-primary);">
          No content found
        </h2>
        <p style="color: var(--color-text-muted);">
          There is no content tagged with "{displayTag}" yet.
        </p>
      </div>
    )}
  </div>
</Layout>
