---
import Layout from "../../components/Layout.astro";
import { supabase } from "../../utils/database";
import type { PostWithTags } from "../../../supabase/types";

export const prerender = false;

const { tag } = Astro.params;

let posts: PostWithTags[] | null = null;
let tagInfo: { name: string; slug: string } | null = null;
let error: string | null = null;

if (supabase && tag) {
  // First, get the tag info
  const { data: tagData, error: tagError } = await supabase
    .from("tags")
    .select("name, slug")
    .eq("slug", tag)
    .single();

  if (tagError || !tagData) {
    error = "Tag not found";
  } else {
    tagInfo = tagData;
    
    // Get posts with this tag
    const { data: postsData, error: postsError } = await supabase
      .from("posts")
      .select(`
        *,
        post_tags!inner(
          tags!inner(
            id,
            name,
            slug
          )
        )
      `)
      .eq("post_tags.tags.slug", tag)
      .order("created_at", { ascending: false });

    if (postsError) {
      error = postsError.message;
    } else {
      // Transform the data to match PostWithTags type
      posts = postsData?.map((post: any) => ({
        ...post,
        post_tags: post.post_tags.map((pt: any) => ({ tags: pt.tags }))
      })) || null;
    }
  }
}

if (!supabase) {
  error = "Database not connected";
}
---

<Layout title={tagInfo ? `Posts tagged "${tagInfo.name}"` : "Tag not found"}>
  {error ? (
    <div class="text-center py-12">
      <h1 class="text-4xl font-bold text-gray-900 mb-4">Tag Not Found</h1>
      <p class="text-gray-600 mb-8">{error}</p>
      <a href="/" class="text-blue-600 hover:text-blue-800 underline">
        Back to Home
      </a>
    </div>
  ) : (
    <>
      <div class="mb-8">
        <h1 class="text-4xl font-bold mb-4">
          Posts tagged "{tagInfo?.name}"
        </h1>
        <a href="/" class="text-blue-600 hover:text-blue-800 underline">
          ‚Üê Back to all posts
        </a>
      </div>

      {posts && posts.length > 0 ? (
        <div class="space-y-8">
          {posts.map((post) => (
            <article class="border-b border-gray-200 pb-8">
              <h2 class="text-2xl font-bold mb-2">
                <a href={`/posts/${post.slug}`} class="hover:text-blue-600">
                  {post.title}
                </a>
              </h2>
              <p class="text-gray-600 mb-4">
                {new Date(post.created_at).toLocaleDateString()}
              </p>
              <div class="prose prose-invert max-w-none mb-4">
                {post.content.substring(0, 200)}...
              </div>
              {post.post_tags && post.post_tags.length > 0 && (
                <div class="flex flex-wrap gap-2">
                  {post.post_tags.map((postTag) => (
                    <a
                      href={`/tags/${postTag.tags.slug}`}
                      class="bg-blue-100 text-blue-800 text-sm px-2 py-1 rounded hover:bg-blue-200 transition-colors"
                    >
                      {postTag.tags.name}
                    </a>
                  ))}
                </div>
              )}
            </article>
          ))}
        </div>
      ) : (
        <div class="text-center py-12">
          <h2 class="text-2xl font-bold text-gray-900 mb-4">No posts found</h2>
          <p class="text-gray-600">
            There are no posts tagged with "{tagInfo?.name}" yet.
          </p>
        </div>
      )}
    </>
  )}
</Layout>