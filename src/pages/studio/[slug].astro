---
/**
 * Aphorism Template
 * Dynamic page for Studio aphorisms with MDX support
 */

import { getCollection, type CollectionEntry } from 'astro:content';
import StudioLayout from '../../studio/StudioLayout.astro';
import AudioPlayer from '../../studio/components/AudioPlayer.astro';

// In SSR (Netlify adapter), getStaticPaths is ignored for dynamic routes.
// Resolve the aphorism at request time using the slug param.
export const prerender = false;
const { slug } = Astro.params;
const allAphorisms = await getCollection('studio');
const aphorism = allAphorisms.find((a) => a.slug === slug) as CollectionEntry<'studio'> | undefined;

if (!aphorism) {
  return new Response('Not found', { status: 404 });
}

// Render MDX for type: 'content' collections
const { Content } = await aphorism.render();

// Format date
const publishedDate = aphorism.data.published.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

const updatedDate = aphorism.data.updated?.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});
---

<StudioLayout 
  title={aphorism.data.title}
  subtitle={aphorism.data.subtitle}
  palette={aphorism.data.palette}
  motion={aphorism.data.motion}
>
  <article class="aphorism">
    <!-- Header -->
    <header class="aphorism-header">
      <h1 class="aphorism-title">{aphorism.data.title}</h1>
      {aphorism.data.subtitle && (
        <p class="aphorism-subtitle">{aphorism.data.subtitle}</p>
      )}
      
      <div class="aphorism-meta">
        <time datetime={aphorism.data.published.toISOString()} class="aphorism-date">
          {publishedDate}
        </time>
        {updatedDate && (
          <>
            <span class="aphorism-meta-sep">·</span>
            <span class="aphorism-updated">Updated {updatedDate}</span>
          </>
        )}
        {aphorism.data.tags.length > 0 && (
          <>
            <span class="aphorism-meta-sep">·</span>
            <div class="aphorism-tags">
              {aphorism.data.tags.map(tag => (
                <span class="aphorism-tag">{tag}</span>
              ))}
            </div>
          </>
        )}
      </div>

      {aphorism.data.text && (
        <p class="aphorism-text-display">{aphorism.data.text}</p>
      )}
    </header>

    <!-- Content -->
    <div class="aphorism-content studio-prose">
      <Content />
    </div>

    <!-- Footer -->
    <footer class="aphorism-footer">
      <div class="aphorism-back">
        <a href="/studio" class="aphorism-back-link">← Back to aphorisms</a>
      </div>
    </footer>
  </article>

  <!-- Audio player (only if audio specified) -->
  {aphorism.data.audio && (
    <AudioPlayer src={aphorism.data.audio} title="Aphorism ambience" />
  )}

  <style>
    .aphorism {
      max-width: 720px;
      margin: 0 auto;
    }

    /* Header */
    .aphorism-header {
      margin-bottom: var(--studio-space-16);
      padding-bottom: var(--studio-space-8);
      border-bottom: 1px solid var(--studio-border);
      opacity: 0;
      animation: fadeIn var(--studio-duration-slow) var(--studio-ease-out) forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .aphorism-title {
      font-family: var(--studio-font-sans);
      font-size: var(--studio-text-4xl);
      font-weight: 600;
      letter-spacing: var(--studio-tracking-tight);
      line-height: var(--studio-leading-tight);
      color: var(--studio-text-primary);
      margin-bottom: var(--studio-space-4);
      max-width: none;
    }

    .aphorism-subtitle {
      font-family: var(--studio-font-sans);
      font-size: var(--studio-text-xl);
      font-weight: 400;
      color: var(--studio-text-muted);
      margin-bottom: var(--studio-space-6);
      letter-spacing: var(--studio-tracking-normal);
    }

    .aphorism-meta {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: var(--studio-space-3);
      font-family: var(--studio-font-sans);
      font-size: var(--studio-text-xs);
      letter-spacing: var(--studio-tracking-wide);
      text-transform: uppercase;
      color: var(--studio-text-muted);
      margin-bottom: var(--studio-space-6);
    }

    .aphorism-date {
      color: var(--studio-text-secondary);
    }

    .aphorism-updated {
      color: var(--studio-text-muted);
      font-style: italic;
    }

    .aphorism-meta-sep {
      color: var(--studio-border);
    }

    .aphorism-tags {
      display: flex;
      gap: var(--studio-space-2);
      flex-wrap: wrap;
    }

    .aphorism-tag {
      font-family: var(--studio-font-mono);
      font-size: var(--studio-text-xs);
      color: var(--studio-accent-dim);
      background-color: var(--studio-bg-tertiary);
      padding: var(--studio-space-1) var(--studio-space-2);
      border-radius: 3px;
      text-transform: none;
    }

    .aphorism-text-display {
      font-size: var(--studio-text-2xl);
      line-height: var(--studio-leading-relaxed);
      color: var(--studio-text-primary);
      font-style: italic;
      margin-top: var(--studio-space-6);
      padding-top: var(--studio-space-6);
      border-top: 1px solid var(--studio-border);
      text-align: center;
    }

    /* Content */
    .aphorism-content {
      opacity: 0;
      animation: fadeIn var(--studio-duration-slow) var(--studio-ease-out) 0.2s forwards;
      position: relative;
    }

    /* Reduced padding for margin notes on aphorisms (simpler than essays) */
    @media (min-width: 1024px) {
      .aphorism-content {
        padding-right: 150px;
      }
    }

    /* Footer */
    .aphorism-footer {
      margin-top: var(--studio-space-16);
      padding-top: var(--studio-space-8);
      border-top: 1px solid var(--studio-border);
    }

    .aphorism-back-link {
      font-family: var(--studio-font-sans);
      font-size: var(--studio-text-sm);
      color: var(--studio-text-muted);
      text-decoration: none;
      letter-spacing: var(--studio-tracking-wide);
      transition: color var(--studio-duration-normal) var(--studio-ease-out);
      display: inline-flex;
      align-items: center;
      gap: var(--studio-space-2);
      border: none;
    }

    .aphorism-back-link:hover {
      color: var(--studio-text-primary);
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      .aphorism-title {
        font-size: var(--studio-text-3xl);
      }

      .aphorism-subtitle {
        font-size: var(--studio-text-lg);
      }

      .aphorism-text-display {
        font-size: var(--studio-text-xl);
      }
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
      .aphorism-header,
      .aphorism-content {
        animation: none;
        opacity: 1;
      }
    }
  </style>
</StudioLayout>
