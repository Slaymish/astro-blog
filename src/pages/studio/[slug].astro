---
/**
 * Aphorism Template
 */

import StudioLayout from '../../studio/StudioLayout.astro';
import AudioPlayer from '../../studio/components/AudioPlayer.astro';
import { fetchSanity } from '../../lib/sanity';
import { portableTextToHtml } from '../../lib/portableText';

export const prerender = false;

type AphorismDoc = {
  title: string;
  subtitle?: string;
  slug: string;
  status?: string;
  publishedAt?: string;
  updatedAt?: string;
  tags?: string[];
  text?: string;
  audio?: string;
  palette?: string;
  motion?: string;
  body?: any;
};

const { slug } = Astro.params;
const aphorism = await fetchSanity<AphorismDoc | null>(`
  *[_type == "aphorism" && slug.current == $slug][0]{
    title,
    subtitle,
    "slug": slug.current,
    status,
    publishedAt,
    updatedAt,
    tags,
    text,
    audio,
    palette,
    motion,
    body
  }
`, { slug });

if (!aphorism) {
  return new Response('Not found', { status: 404 });
}

const htmlContent = portableTextToHtml(aphorism.body);

const palette =
  aphorism.palette === 'noir' ||
  aphorism.palette === 'sepia' ||
  aphorism.palette === 'forest' ||
  aphorism.palette === 'ocean' ||
  aphorism.palette === 'ember'
    ? aphorism.palette
    : 'noir';

const motion =
  aphorism.motion === 'subtle' ||
  aphorism.motion === 'moderate' ||
  aphorism.motion === 'expressive'
    ? aphorism.motion
    : 'subtle';

const publishedDate = aphorism.publishedAt
  ? new Date(aphorism.publishedAt).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    })
  : '';

const updatedDate = aphorism.updatedAt
  ? new Date(aphorism.updatedAt).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    })
  : '';
---

<StudioLayout 
  title={aphorism.title}
  subtitle={aphorism.subtitle}
  palette={palette}
  motion={motion}
>
  <article class="aphorism">
    <!-- Header -->
    <header class="aphorism-header">
      <h1 class="aphorism-title">{aphorism.title}</h1>
      {aphorism.subtitle && (
        <p class="aphorism-subtitle">{aphorism.subtitle}</p>
      )}
      
      <div class="aphorism-meta">
        {aphorism.publishedAt && (
          <time datetime={aphorism.publishedAt} class="aphorism-date">
            {publishedDate}
          </time>
        )}
        {updatedDate && (
          <>
            <span class="aphorism-meta-sep">·</span>
            <span class="aphorism-updated">Updated {updatedDate}</span>
          </>
        )}
        {aphorism.tags && aphorism.tags.length > 0 && (
          <>
            <span class="aphorism-meta-sep">·</span>
            <div class="aphorism-tags">
              {aphorism.tags.map(tag => (
                <span class="aphorism-tag">{tag}</span>
              ))}
            </div>
          </>
        )}
      </div>

      {aphorism.text && (
        <p class="aphorism-text-display">{aphorism.text}</p>
      )}
    </header>

    <!-- Content -->
    {htmlContent && (
      <div class="aphorism-content studio-prose" set:html={htmlContent}></div>
    )}

    <!-- Footer -->
    <footer class="aphorism-footer">
      <div class="aphorism-back">
        <a href="/studio" class="aphorism-back-link">← Back to aphorisms</a>
      </div>
    </footer>
  </article>

  <!-- Audio player (only if audio specified) -->
  {aphorism.audio && (
    <AudioPlayer src={aphorism.audio} title="Aphorism ambience" />
  )}

  <style>
    .aphorism {
      max-width: 720px;
      margin: 0 auto;
    }

    /* Header */
    .aphorism-header {
      margin-bottom: var(--studio-space-16);
      padding-bottom: var(--studio-space-8);
      border-bottom: 1px solid var(--studio-border);
      opacity: 0;
      animation: fadeIn var(--studio-duration-slow) var(--studio-ease-out) forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .aphorism-title {
      font-family: var(--studio-font-sans);
      font-size: var(--studio-text-4xl);
      font-weight: 600;
      letter-spacing: var(--studio-tracking-tight);
      line-height: var(--studio-leading-tight);
      color: var(--studio-text-primary);
      margin-bottom: var(--studio-space-4);
      max-width: none;
    }

    .aphorism-subtitle {
      font-family: var(--studio-font-sans);
      font-size: var(--studio-text-xl);
      font-weight: 400;
      color: var(--studio-text-muted);
      margin-bottom: var(--studio-space-6);
      letter-spacing: var(--studio-tracking-normal);
    }

    .aphorism-meta {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: var(--studio-space-3);
      font-family: var(--studio-font-sans);
      font-size: var(--studio-text-xs);
      letter-spacing: var(--studio-tracking-wide);
      text-transform: uppercase;
      color: var(--studio-text-muted);
      margin-bottom: var(--studio-space-6);
    }

    .aphorism-date {
      color: var(--studio-text-secondary);
    }

    .aphorism-updated {
      color: var(--studio-text-muted);
      font-style: italic;
    }

    .aphorism-meta-sep {
      color: var(--studio-border);
    }

    .aphorism-tags {
      display: flex;
      gap: var(--studio-space-2);
      flex-wrap: wrap;
    }

    .aphorism-tag {
      font-family: var(--studio-font-mono);
      font-size: var(--studio-text-xs);
      color: var(--studio-accent-dim);
      background-color: var(--studio-bg-tertiary);
      padding: var(--studio-space-1) var(--studio-space-2);
      border-radius: 3px;
      text-transform: none;
    }

    .aphorism-text-display {
      font-size: var(--studio-text-2xl);
      line-height: var(--studio-leading-relaxed);
      color: var(--studio-text-primary);
      font-style: italic;
      margin-top: var(--studio-space-6);
      padding-top: var(--studio-space-6);
      border-top: 1px solid var(--studio-border);
      text-align: center;
    }

    /* Content */
    .aphorism-content {
      opacity: 0;
      animation: fadeIn var(--studio-duration-slow) var(--studio-ease-out) 0.2s forwards;
      position: relative;
    }

    /* Reduced padding for margin notes on aphorisms (simpler than essays) */
    @media (min-width: 1024px) {
      .aphorism-content {
        padding-right: 150px;
      }
    }

    /* Footer */
    .aphorism-footer {
      margin-top: var(--studio-space-16);
      padding-top: var(--studio-space-8);
      border-top: 1px solid var(--studio-border);
    }

    .aphorism-back-link {
      font-family: var(--studio-font-sans);
      font-size: var(--studio-text-sm);
    }
  </style>
</StudioLayout>
