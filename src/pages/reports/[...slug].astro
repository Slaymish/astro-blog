---
import Layout from '../../components/layout/Layout.astro';
import Breadcrumb from '../../components/features/Breadcrumb.astro';
import PDFViewer from '../../components/features/PDFViewer.astro';
import { calculateReadingTime } from '../../utils/reading-time';
import { createSlug } from '../../utils/slug';
import { fetchSanity } from '../../lib/sanity';
import { portableTextToHtml, portableTextToPlainText } from '../../lib/portableText';

export const prerender = true;

type ReportDoc = {
  title: string;
  slug: string;
  publishedAt: string;
  description?: string;
  tags?: string[];
  pdfUrl?: string;
  body?: any;
};

export async function getStaticPaths() {
  const reports = await fetchSanity<Array<{ slug: string }>>(`
    *[_type == "report" && defined(slug.current)]{ "slug": slug.current }
  `);

  return reports.map(r => ({
    params: { slug: r.slug }
  }));
}

const slug = Astro.params.slug as string;

const report = await fetchSanity<ReportDoc | null>(`
  *[_type == "report" && slug.current == $slug][0]{
    title,
    "slug": slug.current,
    publishedAt,
    description,
    tags,
    "pdfUrl": pdfFile.asset->url,
    body
  }
`, { slug });

if (!report) {
  throw new Error(`Report not found: ${slug}`);
}

const htmlContent = portableTextToHtml(report.body);
const plainText = portableTextToPlainText(report.body);
const readingTime = calculateReadingTime(plainText);

const description = report.description || (plainText.length > 160 
  ? plainText.substring(0, 157) + '...' 
  : plainText);

const publishedTime = new Date(report.publishedAt).toISOString();
---

<Layout 
  title={report.title}
  description={description}
  article={true}
  publishedTime={publishedTime}
  tags={report.tags || []}
  canonicalURL={`${Astro.url.origin}/reports/${report.slug}`}
>
  <Breadcrumb items={[
    { name: "Reports", url: "/" },
    { name: report.title, url: `/reports/${report.slug}` }
  ]} />
  
  <article 
    class="max-w-4xl mx-auto"
    itemscope 
    itemtype="http://schema.org/ScholarlyArticle"
  >
    <header class="mb-8">
      <h1 
        class="text-4xl font-bold mb-4" 
        style="color: var(--color-text-primary);"
        itemprop="headline"
      >
        {report.title}
      </h1>
      
      <div class="flex items-center gap-4 mb-4" style="color: var(--color-text-muted);">
        <time 
          datetime={report.publishedAt}
          itemprop="datePublished"
        >
          {new Date(report.publishedAt).toLocaleDateString("en-US", {
            year: "numeric",
            month: "long",
            day: "numeric"
          })}
        </time>
        
        {plainText && (
          <>
            <span>•</span>
            <time 
              itemprop="timeRequired" 
              datetime={`PT${readingTime.minutes}M`}
              title={`${readingTime.words} words`}
            >
              {readingTime.text}
            </time>
          </>
        )}
        
        <span itemprop="author" itemscope itemtype="http://schema.org/Person" style="display: none;">
          <span itemprop="name">Hamish Burke</span>
          <span itemprop="url">https://hamishburke.dev</span>
        </span>
        
        <span itemprop="publisher" itemscope itemtype="http://schema.org/Person" style="display: none;">
          <span itemprop="name">Hamish Burke</span>
          <span itemprop="url">https://hamishburke.dev</span>
        </span>
      </div>

      {report.tags && report.tags.length > 0 && (
        <div class="flex flex-wrap gap-2 mb-8" role="list" aria-label="Report tags">
          {report.tags.map((tag: string, index: number) => {
            const colorVariant = index % 3;
            let bgColor = 'var(--color-tag-bg)';
            let textColor = 'var(--color-tag-text)';
            
            if (colorVariant === 1) {
              bgColor = 'var(--color-tag-accent1-bg)';
              textColor = 'var(--color-tag-accent1-text)';
            } else if (colorVariant === 2) {
              bgColor = 'var(--color-tag-accent2-bg)';
              textColor = 'var(--color-tag-accent2-text)';
            }
            
            return (
              <a
                role="listitem"
                href={`/tags/${createSlug(tag)}`}
                class="text-sm px-3 py-1 rounded-full hover:opacity-80 transition-all"
                style={`background-color: ${bgColor}; color: ${textColor};`}
                itemprop="keywords"
              >
                {tag}
              </a>
            );
          })}
        </div>
      )}
    </header>

    {report.pdfUrl && (
      <div class="pdf-section mb-8">
        <PDFViewer pdfPath={report.pdfUrl} title={report.title} />
      </div>
    )}

    {htmlContent && (
      <div 
        class="prose prose-invert max-w-none" 
        itemprop="articleBody"
        set:html={htmlContent}
      ></div>
    )}
    
    <footer class="mt-12 pt-8" style="border-top: 1px solid var(--color-border-secondary);">
      <nav aria-label="Report navigation">
        <a href="/" style="color: var(--color-link);" class="hover:underline">
          ← Back to home
        </a>
      </nav>
    </footer>
  </article>
</Layout>
