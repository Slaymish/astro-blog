---
import Layout from "../../components/layout/Layout.astro";
import GridTile from "../../components/ui/GridTile.astro";
import { fetchSanity } from "../../lib/sanity";

export const prerender = false;

type PostDoc = {
  title: string;
  excerpt?: string;
  publishedAt: string;
  slug: string;
  tags?: string[];
};

type ReportDoc = {
  title: string;
  description?: string;
  publishedAt: string;
  slug: string;
  tags?: string[];
};

type DisplayItem = (PostDoc & { _type: 'post' }) | (ReportDoc & { _type: 'report' } & { excerpt?: string });

const posts = await fetchSanity<PostDoc[]>(`
  *[_type == "post"] | order(publishedAt desc){
    title,
    excerpt,
    publishedAt,
    "slug": slug.current,
    tags
  }
`);

const reports = await fetchSanity<ReportDoc[]>(`
  *[_type == "report"] | order(publishedAt desc){
    title,
    description,
    publishedAt,
    "slug": slug.current,
    tags
  }
`);

// Combine posts and reports, marking reports with a type
const displayPosts: DisplayItem[] = [
  ...posts.map(p => ({ ...p, _type: 'post' as const })),
  ...reports.map(r => ({ ...r, excerpt: r.description, _type: 'report' as const }))
].sort((a, b) => new Date(b.publishedAt).getTime() - new Date(a.publishedAt).getTime());

// Get all unique tags
const allTags = [...new Set(
  displayPosts.flatMap(post => post.tags || [])
)].sort();

// Pre-compute post tiles data
const postTiles = displayPosts.map((post) => ({
  title: post.title || 'Untitled',
  description: post.excerpt || '',
  href: post._type === 'report' ? `/reports/${post.slug}` : `/posts/${post.slug}`,
  size: 'square' as const,
  tags: post.tags || [],
  date: post.publishedAt
    ? new Date(post.publishedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short' })
    : '',
  type: post._type
}));
---

<Layout
  title="Writing"
  description="Essays, tutorials, and thoughts on technology, software engineering, and more."
>
  <div class="writing-page">
    <header class="page-header">
      <h1 class="page-title">writing.</h1>
      <p class="page-subtitle">Essays, tutorials, and thoughts on technology, software engineering, and more.</p>
    </header>

    {allTags.length > 0 && (
      <div class="filter-panel">
        <span class="filter-label">Filter by tag:</span>
        <div class="filter-tags">
          <button class="filter-tag active" data-tag="all">All</button>
          {allTags.map(tag => (
            <button class="filter-tag" data-tag={tag}>{tag}</button>
          ))}
        </div>
      </div>
    )}

    <div class="posts-grid grid grid-cols-1 gap-3 sm:grid-flow-row-dense sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3" id="posts-grid">
      {postTiles.map(tile => <GridTile {...tile} />)}
    </div>

    {displayPosts.length === 0 && (
      <div class="empty-state">
        <p>No posts yet. Check back soon!</p>
      </div>
    )}
  </div>
</Layout>

<script>
  // Simple filter functionality
  const tagButtons = document.querySelectorAll('.filter-tag[data-tag]');
  const allTiles = document.querySelectorAll('.grid-tile');

  tagButtons.forEach(button => {
    button.addEventListener('click', () => {
      const tag = button.getAttribute('data-tag');

      if (!tag) return;

      // Update active state
      tagButtons.forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');

      // Filter tiles
      allTiles.forEach(tile => {
        const htmlTile = tile as HTMLElement;
        if (tag === 'all') {
          htmlTile.style.display = 'block';
        } else {
          const tags = tile.querySelectorAll('.tile-filter-tag');
          const hasTag = Array.from(tags).some(
            t => t.textContent?.toLowerCase() === tag.toLowerCase()
          );
          htmlTile.style.display = hasTag ? 'block' : 'none';
        }
      });
    });
  });
</script>
