---
import { getCollection, getEntry, render } from "astro:content";
import Layout from "../../components/Layout.astro";
import Breadcrumb from "../../components/Breadcrumb.astro";
import TableOfContents from "../../components/TableOfContents.astro";
import RelatedPosts from "../../components/RelatedPosts.astro";
import { supabase } from "../../utils/database";
import { calculateReadingTime } from "../../utils/reading-time";
import { createSlug } from "../../utils/slug";
import type { PostWithTags } from "../../../supabase/types";
import rehypeFormat from 'rehype-format'
import rehypeKatex from 'rehype-katex'
import rehypeRaw from 'rehype-raw'
import rehypeSlug from 'rehype-slug'
import rehypeStringify from 'rehype-stringify'
import remarkDirective from 'remark-directive'
import remarkFrontmatter from 'remark-frontmatter'
import remarkGfm from 'remark-gfm'
import remarkMath from 'remark-math'
import remarkParse from 'remark-parse'
import remarkRehype from 'remark-rehype'
import {unified} from 'unified'

const processor = unified()
  .use(remarkParse)
  .use(remarkDirective)
  .use(remarkFrontmatter)
  .use(remarkGfm)
  .use(remarkMath)
  .use(remarkRehype, {allowDangerousHtml: true})
  .use(rehypeRaw)
  .use(rehypeSlug)
  .use(rehypeKatex)
  .use(rehypeFormat)
  .use(rehypeStringify)


export const prerender = true;

export async function getStaticPaths() {
  const posts = await getCollection("posts");
  return posts.map((post) => ({
    params: { slug: post.id.replace(/\.(md|mdx)$/, "") },
  }));
}

const { slug } = Astro.params;

let post: PostWithTags | null = null;
type ContentPost = Awaited<ReturnType<typeof getEntry>>;
let contentPost: ContentPost | null = null;
let htmlContent = "";
let markdownContent = "";
let renderedContent: any = null;
let postSlug = "";

if (supabase && slug) {
  const { data } = await supabase
    .from("posts")
    .select(`
      *,
      post_tags(
        tags(
          id,
          name,
          slug
        )
      )
    `)
    .eq("slug", slug)
    .single();
  
  post = data as PostWithTags | null;
}

if (!post && slug) {
  contentPost = await getEntry("posts", slug);
}

if (!post) {
  if (!contentPost) {
    return Astro.redirect("/404");
  }
}

if (post) {
  const file = await processor.process(post.content);
  htmlContent = String(file);
  markdownContent = post.content;
  postSlug = post.slug;
} else if (contentPost) {
  const { Content } = await render(contentPost);
  renderedContent = Content;
  markdownContent = contentPost.body ?? "";
  postSlug = contentPost.id.replace(/\.(md|mdx)$/, "");
}

// Calculate reading time
const readingTime = calculateReadingTime(markdownContent);

// Extract description from content (first 160 characters, cleaned)
const textContent = markdownContent.replace(/[#*`\[\]]/g, '').trim();
const description = textContent.length > 160 
  ? textContent.substring(0, 157) + '...' 
  : textContent;

// Format dates for meta tags
const publishedTime = post
  ? new Date(post.created_at).toISOString()
  : new Date(contentPost?.data.pubDate ?? Date.now()).toISOString();
const modifiedTime = post && post.updated_at !== post.created_at
  ? new Date(post.updated_at).toISOString()
  : publishedTime;

// Get tag names
const tagNames = post
  ? post.post_tags?.map((pt: any) => pt.tags.name) || []
  : contentPost?.data.tags || [];

const tagLinks = post
  ? post.post_tags?.map((pt: any) => ({
      name: pt.tags.name,
      slug: pt.tags.slug ?? createSlug(pt.tags.name),
    })) || []
  : (contentPost?.data.tags || []).map((tag) => ({
      name: tag,
      slug: createSlug(tag),
    }));

const postTitle = post?.title ?? contentPost?.data.title ?? "Untitled";
const postDate = post?.created_at ?? contentPost?.data.pubDate ?? new Date();
const postDateISO = new Date(postDate).toISOString();
const postUpdatedISO = post?.updated_at ? new Date(post.updated_at).toISOString() : "";
const postUpdatedLabel = post?.updated_at
  ? new Date(post.updated_at).toLocaleDateString("en-US", {
      year: "numeric",
      month: "long",
      day: "numeric"
    })
  : "";
const showUpdated = Boolean(post && post.updated_at !== post.created_at);
const RenderedContent = renderedContent;
---

<Layout 
  title={postTitle}
  description={description}
  article={true}
  publishedTime={publishedTime}
  modifiedTime={modifiedTime}
  tags={tagNames}
  canonicalURL={`${Astro.url.origin}/posts/${postSlug}`}
>
  <Breadcrumb items={[
    { name: "Posts", url: "/" },
    { name: postTitle, url: `/posts/${postSlug}` }
  ]} />
  
  <article 
    class="max-w-4xl mx-auto"
    itemscope 
    itemtype="http://schema.org/BlogPosting"
  >
    <header class="mb-8">
      <h1 
        class="text-4xl font-bold mb-4" 
        style="color: var(--color-text-primary);"
        itemprop="headline"
      >
        {postTitle}
      </h1>
      
      <div class="flex items-center gap-4 mb-4" style="color: var(--color-text-muted);">
        <time 
          datetime={postDateISO}
          itemprop="datePublished"
        >
          {new Date(postDate).toLocaleDateString("en-US", {
            year: "numeric",
            month: "long",
            day: "numeric"
          })}
        </time>
        
        <span>•</span>
        
        <time 
          itemprop="timeRequired" 
          datetime={`PT${readingTime.minutes}M`}
          title={`${readingTime.words} words`}
        >
          {readingTime.text}
        </time>
        
        {showUpdated && (
          <>
            <span>•</span>
            <span>
              Updated <time 
                datetime={postUpdatedISO}
                itemprop="dateModified"
              >
                {postUpdatedLabel}
              </time>
            </span>
          </>
        )}
        
        <!-- Hidden author info for schema -->
        <span itemprop="author" itemscope itemtype="http://schema.org/Person" style="display: none;">
          <span itemprop="name">Hamish Burke</span>
          <span itemprop="url">https://hamishburke.dev</span>
        </span>
        
        <!-- Hidden publisher info for schema -->
        <span itemprop="publisher" itemscope itemtype="http://schema.org/Person" style="display: none;">
          <span itemprop="name">Hamish Burke</span>
          <span itemprop="url">https://hamishburke.dev</span>
        </span>
      </div>
      {tagLinks.length > 0 && (
        <div class="flex flex-wrap gap-2 mb-8" role="list" aria-label="Article tags">
          {tagLinks.map((tag, index) => {
            // Cycle through different tag colors for visual variety
            const colorVariant = index % 3;
            let bgColor = 'var(--color-tag-bg)';
            let textColor = 'var(--color-tag-text)';
            
            if (colorVariant === 1) {
              bgColor = 'var(--color-tag-accent1-bg)';
              textColor = 'var(--color-tag-accent1-text)';
            } else if (colorVariant === 2) {
              bgColor = 'var(--color-tag-accent2-bg)';
              textColor = 'var(--color-tag-accent2-text)';
            }
            
            return (
              <a
                role="listitem"
                href={`/tags/${tag.slug}`}
                class="text-sm px-3 py-1 rounded-full hover:opacity-80 transition-all"
                style={`background-color: ${bgColor}; color: ${textColor};`}
                itemprop="keywords"
              >
                {tag.name}
              </a>
            );
          })}
        </div>
      )}
    </header>
    
    <TableOfContents content={markdownContent} htmlContent={htmlContent || undefined} />
    
    {RenderedContent ? (
      <div class="prose prose-invert max-w-none" itemprop="articleBody">
        <RenderedContent />
      </div>
    ) : (
      <div 
        class="prose prose-invert max-w-none" 
        set:html={htmlContent}
        itemprop="articleBody"
      >
      </div>
    )}
    
    {post && (
      <RelatedPosts 
        currentPostId={post.id}
        currentPostTags={tagNames}
      />
    )}
    
    <footer class="mt-12 pt-8" style="border-top: 1px solid var(--color-border-secondary);">
      <nav aria-label="Post navigation">
        <a href="/" style="color: var(--color-link);" class="hover:underline">
          ← Back to all posts
        </a>
      </nav>
    </footer>
  </article>
</Layout>
