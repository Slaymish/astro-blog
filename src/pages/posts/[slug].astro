---
import Layout from "../../components/layout/Layout.astro";
import Breadcrumb from "../../components/features/Breadcrumb.astro";
import TableOfContents from "../../components/features/TableOfContents.astro";
import RelatedPosts from "../../components/features/RelatedPosts.astro";
import { calculateReadingTime } from "../../utils/reading-time";
import { createSlug } from "../../utils/slug";
import { fetchSanity } from "../../lib/sanity";
import { portableTextToHtml, portableTextToPlainText } from "../../lib/portableText";
import { markdownToHtml, markdownToPlainText } from "../../lib/markdown";

export const prerender = false;

type PostDoc = {
  title: string;
  slug: string;
  publishedAt: string;
  updatedAt?: string;
  tags?: string[];
  excerpt?: string;
  body?: any;
  markdownBody?: string;
};

export async function getStaticPaths() {
  const posts = await fetchSanity<Array<{ slug: string }>>(`
    *[_type == "post" && defined(slug.current)]{ "slug": slug.current }
  `);

  return posts.map((post) => ({
    params: { slug: post.slug }
  }));
}

const { slug } = Astro.params;

const post = await fetchSanity<PostDoc | null>(`
  *[_type == "post" && slug.current == $slug][0]{
    title,
    "slug": slug.current,
    publishedAt,
    updatedAt,
    tags,
    excerpt,
    body,
    markdownBody
  }
`, { slug });

if (!post) {
  return Astro.redirect("/404");
}

const htmlContent = post.markdownBody
  ? markdownToHtml(post.markdownBody)
  : portableTextToHtml(post.body);

const plainText = post.markdownBody
  ? markdownToPlainText(post.markdownBody)
  : portableTextToPlainText(post.body);
const markdownContent = plainText;

const readingTime = calculateReadingTime(plainText);

const description = post.excerpt
  ? post.excerpt
  : plainText.length > 160
    ? plainText.substring(0, 157) + '...'
    : plainText;

const publishedTime = new Date(post.publishedAt).toISOString();
const modifiedTime = post.updatedAt ? new Date(post.updatedAt).toISOString() : publishedTime;

const contentTags = (post.tags ?? []) as string[];
const tagLinks: Array<{ name: string; slug: string }> = contentTags.map((tag: string) => ({
  name: tag,
  slug: createSlug(tag),
}));

const postTitle = post.title ?? "Untitled";
const postDate = post.publishedAt ?? new Date().toISOString();
const postDateISO = new Date(postDate).toISOString();
const showUpdated = post.updatedAt && post.updatedAt !== post.publishedAt;
const postUpdatedISO = showUpdated ? new Date(post.updatedAt as string).toISOString() : '';
const postUpdatedLabel = showUpdated
  ? new Date(post.updatedAt as string).toLocaleDateString("en-US", {
      year: "numeric",
      month: "long",
      day: "numeric"
    })
  : '';
---

<Layout
  title={postTitle}
  description={description}
  article={true}
  publishedTime={publishedTime}
  modifiedTime={modifiedTime}
  tags={tagLinks.map(tag => tag.name)}
  canonicalURL={`${Astro.url.origin}/posts/${post.slug}`}
>
  <div class="post-layout">
    <article itemscope itemtype="http://schema.org/BlogPosting">
      <header class="post-header">
        <Breadcrumb items={[
          { name: "Writing", url: "/writing" },
          { name: postTitle, url: `/posts/${post.slug}` }
        ]} />

        <h1 itemprop="headline">{postTitle}</h1>

        <div class="post-meta">
          <time datetime={postDateISO} itemprop="datePublished">
            {new Date(postDate).toLocaleDateString("en-US", {
              year: "numeric",
              month: "long",
              day: "numeric"
            })}
          </time>

          <span>·</span>

          <time itemprop="timeRequired" datetime={`PT${readingTime.minutes}M`} title={`${readingTime.words} words`}>
            {readingTime.text}
          </time>

          {showUpdated && (
            <>
              <span>·</span>
              <span>
                Updated <time datetime={postUpdatedISO} itemprop="dateModified">
                  {postUpdatedLabel}
                </time>
              </span>
            </>
          )}
        </div>

        {tagLinks.length > 0 && (
          <div class="post-tags" role="list" aria-label="Article tags">
            {tagLinks.map((tag) => (
              <a
                role="listitem"
                href={`/tags/${tag.slug}`}
                class="tag-link"
                itemprop="keywords"
              >
                {tag.name}
              </a>
            ))}
          </div>
        )}
      </header>

      <div class="prose" itemprop="articleBody" set:html={htmlContent}></div>

      <RelatedPosts
        currentPostSlug={post.slug}
        currentPostTags={tagLinks.map(tag => tag.name)}
      />

      <footer class="post-footer">
        <nav aria-label="Post navigation">
          <a href="/writing" class="back-link">
            ← Back to writing
          </a>
        </nav>
      </footer>
    </article>

    <aside class="post-sidebar">
      <TableOfContents content={markdownContent} htmlContent={htmlContent || undefined} />
    </aside>
  </div>
</Layout>

<style>
  .post-layout {
    display: grid;
    grid-template-columns: 1fr;
    gap: 2rem;
  }

  @media (min-width: 1024px) {
    .post-layout {
      grid-template-columns: minmax(0, 1fr) var(--toc-width);
      grid-template-areas: "content sidebar";
    }
  }

  article {
    max-width: var(--reading-width);
  }

  @media (min-width: 1024px) {
    article {
      grid-area: content;
    }
  }

  .post-header {
    margin-bottom: 2rem;
  }

  .post-header h1 {
    font-family: var(--font-heading);
    font-size: clamp(2rem, 5vw, 2.5rem);
    font-weight: 700;
    line-height: 1.2;
    margin-bottom: 1rem;
    color: var(--text);
    letter-spacing: -0.025em;
  }

  .post-meta {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--text-muted);
    margin-bottom: 1rem;
  }

  .post-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .tag-link {
    background-color: var(--surface-2);
    color: var(--text-muted);
    padding: 0.375rem 0.75rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.15s ease;
    border: 1px solid transparent;
  }

  .tag-link:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  .tag-link::after {
    display: none;
  }

  .post-sidebar {
    display: none;
  }

  @media (min-width: 1024px) {
    .post-sidebar {
      display: block;
      grid-area: sidebar;
      position: sticky;
      top: 2rem;
      max-height: calc(100vh - 4rem);
      overflow-y: auto;
    }
  }

  .post-footer {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid var(--border);
  }

  .back-link {
    color: var(--text-muted);
    text-decoration: none;
    font-weight: 500;
    transition: color 0.15s ease;
  }

  .back-link:hover {
    color: var(--accent);
  }

  .back-link::after {
    display: none;
  }

  /* Ensure prose doesn't exceed reading line length */
  .prose {
    max-width: 65ch;
  }
</style>
