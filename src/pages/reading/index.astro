---
import Layout from "../../components/layout/Layout.astro";
import { fetchSanity, urlFor } from "../../lib/sanity";

export const prerender = false;

type ReadingStatus = 'reading' | 'read' | 'to-read';

type ReadingItem = {
  title: string;
  author: string;
  status: ReadingStatus;
  coverImage?: any;
  link?: string;
};

const readingItems = await fetchSanity<ReadingItem[]>(`
  *[_type == "book"] | order(status asc, title asc){
    title,
    author,
    status,
    coverImage,
    link
  }
`);

const statusLabel: Record<ReadingStatus, string> = {
  reading: 'Reading',
  read: 'Read',
  'to-read': 'To read'
};
---

<Layout
  title="Reading"
  description="What I'm reading, what I've read, and what I hope to read next."
>
  <div class="reading-page">
    <header class="reading-header">
      <h1 class="page-title">reading.</h1>
      <p class="page-subtitle">
        What I'm reading, what I've read, and what I hope to read next.
        Recommendations are always welcome.
      </p>
    </header>

    <section class="reading-grid" aria-label="Reading list">
      <!-- sorted in this order: to-read, reading, read -->
      {readingItems.sort((a, b) => {
        const order = ['to-read', 'reading', 'read'];
        return order.indexOf(a.status) - order.indexOf(b.status);
      }).map((item) => (
        <article class="reading-card">
          <div class="reading-card-meta">
            <span>Reading · Books</span>
            <span aria-hidden="true">
              {item.link ? (
                <a href={item.link} target="_blank" rel="noopener noreferrer">↗</a>
              ) : (
                <span>•</span>
              )}
            </span>
          </div>

          <div class="reading-card-body">
            <div class="book-cover" data-has-cover={item.coverImage ? 'true' : 'false'}>
              {item.link ? (
                <a href={item.link} target="_blank" rel="noopener noreferrer">
                  {item.coverImage ? (
                    <img
                      src={urlFor(item.coverImage).width(240).height(320).fit('crop').url()}
                      alt={`Cover of ${item.title}`}
                      loading="lazy"
                    />
                  ) : (
                    <div class="book-cover-placeholder" aria-hidden="true"></div>
                  )}
                </a>
              ) : (
                <>
                  {item.coverImage ? (
                    <img
                      src={urlFor(item.coverImage).width(240).height(320).fit('crop').url()}
                      alt={`Cover of ${item.title}`}
                      loading="lazy"
                    />
                  ) : (
                    <div class="book-cover-placeholder" aria-hidden="true"></div>
                  )}
                </>
              )}
            </div>

            <div class="reading-card-details">
              <span class="status-chip" data-status={item.status}>
                {statusLabel[item.status]}
              </span>
              <h2 class="reading-card-title">{item.title}</h2>
              <p class="reading-card-author">{item.author}</p>
            </div>
          </div>
        </article>
      ))}
    </section>
  </div>
</Layout>
