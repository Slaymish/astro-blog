---
import Layout from "../components/Layout.astro";
import { supabase } from "../utils/database";
import type { PostWithTags } from "../../supabase/types";

export const prerender = false;

let posts: PostWithTags[] | null = null;
// let postsError;

// Fetch posts data from Supabase if connection is set up
if (supabase) {
  const { data, error } = await supabase
    .from("posts")
    .select(`
      *,
      post_tags(
        tags(
          id,
          name,
          slug
        )
      )
    `)
    .order("created_at", { ascending: false });
  posts = data as PostWithTags[] | null;
  // postsError = error;
}
---

<Layout title="Hamish's Blog">
  {
    supabase ? (
      posts ? (
        <>
          <h1 class="mb-8 text-4xl font-bold" style="color: var(--color-text-primary);">
            Recent Posts
          </h1>
          <div class="space-y-8">
            {posts?.map((post) => (
              <article class="pb-8" style="border-bottom: 1px solid var(--color-border-secondary);">
                <h2 class="text-2xl font-bold mb-2">
                  <a href={`/posts/${post.slug}`} style="color: var(--color-text-primary);" class="hover:underline">
                    {post.title}
                  </a>
                </h2>
                <p class="mb-4" style="color: var(--color-text-muted);">
                  {new Date(post.created_at).toLocaleDateString()}
                </p>
                <div class="prose prose-invert max-w-none mb-4" style="color: var(--color-text-secondary);">
                  {post.content.substring(0, 200)}...
                </div>
                {post.post_tags && post.post_tags.length > 0 && (
                  <div class="flex flex-wrap gap-2">
                    {post.post_tags.map((postTag) => (
                      <a
                        href={`/tags/${postTag.tags.slug}`}
                        class="text-sm px-2 py-1 rounded hover:opacity-80 transition-all"
                        style="background-color: var(--color-tag-bg); color: var(--color-tag-text);"
                      >
                        {postTag.tags.name}
                      </a>
                    ))}
                  </div>
                )}
              </article>
            ))}
          </div>
        </>
      ) : (
        <div class="text-center py-12">
          <h1 class="text-4xl font-bold mb-4" style="color: var(--color-text-secondary);">Welcome to my blog!</h1>
          <p class="mb-8" style="color: var(--color-text-muted);">
            I'm currently setting up the database connection. Please check back soon!
          </p>
        </div>
      )
    ) : (
      <div class="text-center py-12">
        <h1 class="text-4xl font-bold mb-4" style="color: var(--color-text-secondary);">Welcome to my blog!</h1>
        <p class="mb-8" style="color: var(--color-text-muted);">
          I'm currently setting up the database connection. Please check back soon!
        </p>
      </div>
    )
  }
</Layout>
