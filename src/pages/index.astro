---
import Layout from "../components/layout/Layout.astro";
import GridTile from "../components/ui/GridTile.astro";
import { fetchSanity } from "../lib/sanity";

export const prerender = true;

type ProjectDoc = {
  title: string;
  description?: string;
  slug: string;
  date: string;
  technologies?: string[];
};

type PostDoc = {
  title: string;
  excerpt?: string;
  slug: string;
  publishedAt: string;
  tags?: string[];
};

const projects = await fetchSanity<ProjectDoc[]>(`
  *[_type == "project"] | order(date desc)[0...8]{
    title,
    description,
    "slug": slug.current,
    date,
    technologies
  }
`);

const displayPosts = await fetchSanity<PostDoc[]>(`
  *[_type == "post"] | order(publishedAt desc)[0...6]{
    title,
    excerpt,
    "slug": slug.current,
    publishedAt,
    tags
  }
`);

const homeDescription = "Welcome to my personal site - a collection of projects, writing, and thoughts.";

// Pre-compute project tiles data
const projectSizeCycle: Array<'small' | 'medium' | 'large' | 'wide'> = [
  'wide',
  'medium',
  'small',
  'large',
  'medium',
  'small',
  'wide',
  'medium'
];

const projectTiles = projects.map((project, index) => {
  const dateStr = new Date(project.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
  return {
    title: project.title,
    description: project.description,
    href: `/projects/${project.slug}`,
    size: projectSizeCycle[index % projectSizeCycle.length],
    tags: project.technologies || [],
    date: dateStr
  };
});

// Pre-compute post tiles data
const postSizeCycle: Array<'small' | 'medium' | 'large' | 'wide'> = [
  'small',
  'medium',
  'small',
  'wide',
  'medium',
  'small'
];

const postTiles = displayPosts.map((post, index) => {
  const dateStr = new Date(post.publishedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short' });

  return {
    title: post.title,
    description: post.excerpt || '',
    href: `/posts/${post.slug}`,
    size: postSizeCycle[index % postSizeCycle.length],
    tags: post.tags || [],
    date: dateStr
  };
});
---

<Layout
  title="Hamish"
  description={homeDescription}
  canonicalURL={Astro.url.href}
>
  <!-- Masthead Hero Section -->
  <section class="masthead">
    <div class="masthead-content">
      <h1>Hi, I'm Hamish</h1>
      <p class="masthead-text">
        I build things with code and write about technology, software engineering, and whatever I'm learning.
      </p>

      <div class="masthead-actions">
        <a href="mailto:hamishapps@gmail.com" class="primary-button">
          hamishapps@gmail.com
        </a>
      </div>
    </div>
  </section>

  <!-- Mixed-span Bento Grid -->
  <section class="grid-section">
    <div class="bento-grid">
      <!-- Large anchor tile: Personal Dashboard -->
      <div class="tile tile-wide featured-tile">
        <div class="tile-title">
          <span>Personal Dashboard</span>
          <span class="tile-arrow">→</span>
        </div>
        <p class="tile-description">
          A collection of personal tools including HealthAgent, FinanceAgent, and more.
        </p>
        <div class="tile-links">
          <a href="#healthagent">HealthAgent</a>
          <a href="#financeagent">FinanceAgent</a>
        </div>
      </div>

      <!-- Key projects -->
      {projectTiles.slice(0, 3).map(tile => <GridTile {...tile} />)}

      <!-- Small tiles: Writing and hobbies -->
      {postTiles.slice(0, 2).map(tile => <GridTile {...tile} />)}

      <!-- Hobby/info tiles -->
      <div
        class="tile tile-small tile-image"
        style={`--tile-image: url('/images/tiles/bouldering.JPEG')`}
      >
        <div class="tile-title">
          <span>Bouldering</span>
        </div>
        <div class="hobby-list">
          <div><span class="label">Currently:</span> 4/5 Projects (Faultline levels)</div>
          <div><span class="label">Next:</span>6/7</div>
        </div>
      </div>

      <div
        class="tile tile-small tile-image"
        style={`--tile-image: url('/images/tiles/piano.jpg')`}
      >
        <div class="tile-title">
          <span>Piano</span>
        </div>
        <div class="hobby-list">
          <div><span class="label">Currently:</span>Merry Go Round of Life (by Joe Hisaishi)</div>
          <div><span class="label">Next:</span> Talk to me (by Cavetown)</div>
        </div>
      </div>

      <!-- More projects and writing -->
      {projectTiles.slice(3, 6).map(tile => <GridTile {...tile} />)}
      {postTiles.slice(2, 5).map(tile => <GridTile {...tile} />)}

      <!-- Info tiles -->
      <a href="/about" class="tile tile-medium">
        <div class="tile-title">
          <span>About</span>
          <span class="tile-arrow">→</span>
        </div>
        <p class="tile-description">More about me and my background</p>
      </a>

      <a href="https://github.com/Slaymish" target="_blank" rel="noopener noreferrer" class="tile tile-medium">
        <div class="tile-title">
          <span>GitHub</span>
          <span class="tile-arrow">↗</span>
        </div>
        <p class="tile-description">Check out my code and contributions</p>
      </a>
    </div>

    <!-- View more links -->
    <div class="view-more">
      <a href="/projects">View all projects →</a>
      <a href="/writing">View all writing →</a>
    </div>
  </section>
</Layout>

<style>
  .masthead {
    padding: 3rem 0 4rem;
    text-align: center;
  }

  .masthead-content {
    max-width: 40rem;
    margin: 0 auto;
  }

  .masthead h1 {
    font-family: var(--font-heading);
    font-size: clamp(2.5rem, 8vw, 3rem);
    font-weight: 700;
    margin-bottom: 1.5rem;
    letter-spacing: -0.03em;
    color: var(--text);
  }

  .masthead-text {
    font-size: 1.125rem;
    color: var(--text-muted);
    line-height: 1.7;
    margin-bottom: 2rem;
  }

  .masthead-actions {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
  }

  .primary-button {
    font-size: 1rem;
    background-color: var(--accent);
    color: var(--accent-contrast);
    padding: 0.75rem 1.5rem;
    border-radius: var(--radius-base);
    text-decoration: none;
    font-weight: 500;
    transition: background-color 0.15s ease;
  }

  .primary-button:hover {
    background-color: color-mix(in srgb, var(--accent) 85%, black);
  }

  .primary-button::after {
    display: none;
  }

  .secondary-links {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.9375rem;
  }

  .secondary-links a {
    color: var(--text-muted);
    text-decoration: none;
    transition: color 0.15s ease;
  }

  .secondary-links a:hover {
    color: var(--accent);
  }

  .secondary-links span {
    color: var(--border);
  }

  .grid-section {
    margin-bottom: 2rem;
    width: 100vw;
    margin-left: calc(50% - 50vw);
    padding: 0 var(--padding-mobile);
  }

  .featured-tile {
    cursor: default;
  }

  .featured-tile .tile-arrow {
    display: none;
  }

  .tile-links {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-top: auto;
  }

  .tile-links a {
    font-size: 0.875rem;
    color: var(--accent);
    text-decoration: none;
  }

  .tile-links a:hover {
    text-decoration: underline;
  }

  .tile-links a::after {
    display: none;
  }

  .hobby-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--text-muted);
  }

  .hobby-list .label {
    font-weight: 500;
    color: var(--text);
  }

  .view-more {
    display: flex;
    justify-content: center;
    gap: 2rem;
    margin-top: 2rem;
  }

  .view-more a {
    color: var(--text-muted);
    text-decoration: none;
    font-size: 0.9375rem;
    transition: color 0.15s ease;
  }

  .view-more a:hover {
    color: var(--accent);
  }

  .view-more a::after {
    display: none;
  }

  @media (max-width: 768px) {
    .masthead {
      padding: 2rem 0 3rem;
    }

    .masthead h1 {
      font-size: 2.5rem;
    }

    .masthead-text {
      font-size: 1rem;
    }

    .view-more {
      flex-direction: column;
      gap: 1rem;
    }
  }

  @media (min-width: 768px) {
    .grid-section {
      padding: 0 var(--padding-tablet);
    }
  }

  @media (min-width: 1024px) {
    .grid-section {
      padding: 0 var(--padding-desktop);
    }
  }
</style>
