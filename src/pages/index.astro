---
import Layout from "../components/layout/Layout.astro";
import GridTile from "../components/ui/GridTile.astro";
import { fetchSanity, urlFor } from "../lib/sanity";

export const prerender = false;

type ProjectDoc = {
  title: string;
  description?: string;
  slug: string;
  date: string;
  technologies?: string[];
  homeTileSize?: 'square' | 'wide';
};

type PostDoc = {
  title: string;
  excerpt?: string;
  slug: string;
  publishedAt: string;
  tags?: string[];
};

type ReportDoc = {
  title: string;
  description?: string;
  slug: string;
  publishedAt: string;
  tags?: string[];
};

type ReadingItem = {
  title: string;
  author: string;
  status: 'reading' | 'read' | 'to-read';
  coverImage?: any;
  link?: string;
};

const projects = await fetchSanity<ProjectDoc[]>(`
  *[_type == "project"] | order(date desc)[0...8]{
    title,
    description,
    "slug": slug.current,
    date,
    technologies,
    homeTileSize
  }
`);

const posts = await fetchSanity<PostDoc[]>(`
  *[_type == "post"] | order(publishedAt desc)[0...6]{
    title,
    excerpt,
    "slug": slug.current,
    publishedAt,
    tags
  }
`);

const reports = await fetchSanity<ReportDoc[]>(`
  *[_type == "report"] | order(publishedAt desc)[0...6]{
    title,
    description,
    "slug": slug.current,
    publishedAt,
    tags
  }
`);

const readingItems = await fetchSanity<ReadingItem[]>(`
  *[_type == "book" && status == "reading"] | order(title asc)[0...2]{
    title,
    author,
    status,
    coverImage,
    link
  }
`);

const homeDescription = "Welcome to my personal site - a collection of projects, writing, and thoughts.";

const displayPosts = [
  ...posts.map(p => ({ ...p, _type: 'post' as const })),
  ...reports.map(r => ({ ...r, excerpt: r.description, _type: 'report' as const }))
].sort((a, b) => new Date(b.publishedAt).getTime() - new Date(a.publishedAt).getTime());

const projectTiles = projects.map((project) => {
  const dateStr = new Date(project.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
  return {
    title: project.title,
    description: project.description,
    href: `/projects/${project.slug}`,
    size: project.homeTileSize === 'wide' ? 'wide' : 'square',
    tags: project.technologies || [],
    date: dateStr,
    type: 'project' as const
  };
});

const postTiles = displayPosts.map((post) => {
  const dateStr = new Date(post.publishedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short' });

  return {
    title: post.title,
    description: post.excerpt || '',
    href: post._type === 'report' ? `/reports/${post.slug}` : `/posts/${post.slug}`,
    size: 'square',
    tags: post.tags || [],
    date: dateStr,
    type: post._type
  };
});

const readingPreview = readingItems.slice(0, 2);
---

<Layout
  title="Hamish"
  description={homeDescription}
  canonicalURL={Astro.url.href}
>
  <!-- Masthead Hero Section -->
  <section class="masthead">
    <div class="masthead-content">
      <h1 class="masthead-title">Hi, I'm Hamish</h1>
      <p class="masthead-text">
        I build things with code and write about technology, software engineering, and whatever I'm learning.
      </p>

      <div class="masthead-actions">
        <a href="mailto:hamishapps@gmail.com" class="primary-button">
          hamishapps@gmail.com
        </a>
      </div>
    </div>
  </section>

  <!-- Mixed-span Bento Grid -->
  <section class="grid-section">
    <div class="grid grid-cols-1 gap-3 sm:grid-flow-row-dense sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3">


      <!-- Small tiles: Writing and hobbies -->
      {postTiles.slice(0, 2).map(tile => <GridTile {...tile} />)}

      <!-- Key projects -->
      {projectTiles.slice(0, 3).map(tile => <GridTile {...tile} />)}

      <!-- Hobby/info tiles -->
      <div class="aspect-square px-1 pb-2">
        <div
          class="tile-image group relative h-full w-full overflow-hidden rounded-lg tile-surface"
          style={`--tile-image: url('/images/tiles/bouldering.JPEG'); --tile-image-overlay: linear-gradient(180deg, rgba(10, 10, 10, 0.15), rgba(10, 10, 10, 0.55))`}
        >
          <div class="flex items-center justify-between pl-4 pr-2 pt-2 text-sm tracking-tight tile-meta-text">
            <span class="py-1.5">Hobby</span>
          </div>
          <div class="p-5">
            <div class="tile-title">
              <span>Bouldering</span>
            </div>
            <div class="hobby-list">
              <div><span class="label">Currently:</span> 4/5 Projects (Faultline levels)</div>
            </div>
          </div>
        </div>
      </div>

      <div class="aspect-square px-1 pb-2">
        <div
          class="tile-image group relative h-full w-full overflow-hidden rounded-lg tile-surface"
          style={`--tile-image: url('/images/tiles/piano.jpg'); --tile-image-overlay: linear-gradient(180deg, rgba(10, 10, 10, 0.15), rgba(10, 10, 10, 0.55))`}
        >
          <div class="flex items-center justify-between pl-4 pr-2 pt-2 text-sm tracking-tight tile-meta-text">
            <span class="py-1.5">Hobby</span>
          </div>
          <div class="p-5">
            <div class="tile-title">
              <span>Piano</span>
            </div>
            <div class="hobby-list">
              <div><span class="label">Currently:</span>Merry Go Round of Life (by Joe Hisaishi)</div>
              <div><span class="label">Next:</span> Talk to me (by Cavetown)</div>
            </div>
          </div>
        </div>
      </div>

      {readingPreview.map((book) => (
        <div class="aspect-square px-1 pb-2">
          <div class="group h-full w-full overflow-hidden rounded-lg tile-surface">
            <div class="isolate flex h-full w-full flex-col">
              <div class="flex items-center justify-between pl-4 pr-2 pt-2 text-sm tracking-tight tile-meta-text">
                <span class="py-1.5">
                  <a
                    href="/reading"
                    class="transition-colors focus-visible:ring-4 focus-visible:ring-blue-200 focus-visible:text-neutral-500 focus-visible:underline hover:text-neutral-500 hover:underline"
                  >
                    Reading
                  </a>
                  &nbsp;·&nbsp;Books
                </span>
                {book.link && (
                  <a
                    href={book.link}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="flex h-8 w-8 items-center justify-center rounded-full transition-colors focus-visible:ring-4 focus-visible:ring-blue-200 group-focus-within:bg-white group-focus-within:text-neutral-900 group-hover:bg-white group-hover:text-neutral-900 cursor-alias"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-4 w-4">
                      <path fill-rule="evenodd" d="M5.22 14.78a.75.75 0 001.06 0l7.22-7.22v5.69a.75.75 0 001.5 0v-7.5a.75.75 0 00-.75-.75h-7.5a.75.75 0 000 1.5h5.69l-7.22 7.22a.75.75 0 000 1.06z" clip-rule="evenodd"></path>
                    </svg>
                  </a>
                )}
              </div>
              <div class="grid grow grid-cols-2 items-center gap-6 px-7 pb-8">
                <div class="flex h-full items-center">
                  {book.coverImage ? (
                    <img
                      src={urlFor(book.coverImage).width(240).height(360).fit('max').url()}
                      alt={`Cover of ${book.title}`}
                      class="aspect-[3/4] w-full max-h-full rounded object-contain shadow-lg transition-transform group-focus-within:-rotate-3 group-focus-within:scale-110 group-focus-within:shadow-xl group-hover:-rotate-3 group-hover:scale-110 group-hover:shadow-xl"
                      loading="lazy"
                    />
                  ) : (
                    <div class="aspect-[3/4] w-full rounded bg-neutral-100 shadow-inner"></div>
                  )}
                </div>
                <div class="tracking-tight">
                  <span class="status-chip" data-status="reading">Reading</span>
                  <h3 class="mt-3 line-clamp-3 tile-title-text">{book.title}</h3>
                  <span class="tile-meta-text">{book.author}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      ))}

      <!-- More projects and writing -->
      {projectTiles.slice(3, 6).map(tile => <GridTile {...tile} />)}
      {postTiles.slice(2, 5).map(tile => <GridTile {...tile} />)}

      <!-- Info tiles -->
      <div class="aspect-square px-1 pb-2">
        <div class="group h-full w-full overflow-hidden rounded-lg tile-surface">
          <a href="/about" class="tile-link flex h-full w-full cursor-pointer flex-col justify-between">
            <div class="flex items-center justify-between pl-4 pr-2 pt-2 text-sm tracking-tight tile-meta-text">
              <span class="py-1.5">Navigation</span>
              <span class="flex h-8 w-8 items-center justify-center rounded-full transition-colors focus-visible:ring-4 focus-visible:ring-blue-200 group-focus-within:bg-white group-focus-within:text-neutral-900 group-hover:bg-white group-hover:text-neutral-900">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-4 w-4">
                  <path fill-rule="evenodd" d="M3 10a.75.75 0 01.75-.75h10.69l-3.22-3.22a.75.75 0 111.06-1.06l4.5 4.5a.75.75 0 010 1.06l-4.5 4.5a.75.75 0 11-1.06-1.06l3.22-3.22H3.75A.75.75 0 013 10z" clip-rule="evenodd"></path>
                </svg>
              </span>
            </div>
            <div class="p-5">
              <h3 class="font-serif text-3xl font-light tracking-tight tile-title-text">About</h3>
              <p class="mt-2 text-sm tracking-tight tile-meta-text">More about me and my background</p>
            </div>
          </a>
        </div>
      </div>

      <div class="aspect-square px-1 pb-2">
        <div class="group h-full w-full overflow-hidden rounded-lg tile-surface">
          <a href="https://github.com/Slaymish" target="_blank" rel="noopener noreferrer" class="tile-link flex h-full w-full cursor-alias flex-col justify-between">
            <div class="flex items-center justify-between pl-4 pr-2 pt-2 text-sm tracking-tight tile-meta-text">
              <span class="py-1.5">External</span>
              <span class="flex h-8 w-8 items-center justify-center rounded-full transition-colors focus-visible:ring-4 focus-visible:ring-blue-200 group-focus-within:bg-white group-focus-within:text-neutral-900 group-hover:bg-white group-hover:text-neutral-900">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-4 w-4">
                  <path fill-rule="evenodd" d="M5.22 14.78a.75.75 0 001.06 0l7.22-7.22v5.69a.75.75 0 001.5 0v-7.5a.75.75 0 00-.75-.75h-7.5a.75.75 0 000 1.5h5.69l-7.22 7.22a.75.75 0 000 1.06z" clip-rule="evenodd"></path>
                </svg>
              </span>
            </div>
            <div class="p-5">
              <h3 class="font-serif text-3xl font-light tracking-tight tile-title-text">GitHub</h3>
              <p class="mt-2 text-sm tracking-tight tile-meta-text">Check out my code and contributions</p>
            </div>
          </a>
        </div>
      </div>
    </div>

    <!-- View more links -->
    <div class="view-more">
      <a href="/projects">View all projects →</a>
      <a href="/writing">View all writing →</a>
    </div>
  </section>
</Layout>
